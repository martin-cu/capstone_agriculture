<div class="container-fluid ">
    <div class="d-sm-flex justify-content-between align-items-center mb-4">
        <h3 class="text-dark mb-0">Farms &gt; Work Order</h3><a class="btn btn-primary disabled btn-sm d-none d-sm-inline-block" role="button" style="background: rgba(78,115,223,0);color: #332c1f;border-color: rgba(51,44,31,0);">&nbsp;<br>&nbsp;<i class="far fa-clock" style="margin-right: 5px;"></i>Date<br><br></a>
    </div>
    <div class="card shadow mb-4">
        <div class="card-header d-flex justify-content-between align-items-center" style="background: #939C1F;height: auto;padding: 16px 20px;">
            <h6 class="font-weight-bold m-0" style="color: #FFFFFF;">Detailed Work Order {{work_order.work_order_id}}</h6>
        </div>
        <div class="card-body">
            <form method="post" action="/edit_work_order" id="edit_wo_form">
                <input type="hidden" name="wo_id" value="{{work_order.work_order_id}}" class="hide">
                <div class="">
                    <table class="table table-sm detailed_cont">
                        <thead>
                            <tr>
                                <td style="width: 1px;">Status</td>
                                <td style="width: 50px;">
                                    <select style="height: 28px;padding-top: 3px;padding-bottom: 3px;font-size: 12px;width: 200px;" id="status" name="status" readonly>
                                        <option value="Pending" {{#compareTwoValues work_order.status 'Pending' operator='==='}}selected{{/compareTwoValues}}>Pending</option>
                                        <option value="In-Progress" {{#compareTwoValues work_order.status 'In-Progress' operator='==='}}selected{{/compareTwoValues}}>In-Progress</option>
                                        <option value="Completed" {{#compareTwoValues work_order.status 'Completed' operator='==='}}selected{{/compareTwoValues}}>Completed</option>
                                        {{#if isCancellable}}
                                        <option value="Cancelled" {{#compareTwoValues work_order.status 'Cancelled' operator='==='}}selected{{/compareTwoValues}}>Cancelled</option>
                                        {{/if}}
                                    </select>
                                </td>
                                <td></td>
                                <td>
                                    {{#if editable}}
                                    <button class="btn btn-primary float-right" type="button" id="wo_edit">Edit</button>
                                    {{/if}}
                                </td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4"></td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;">Farm Information</td>
                                <td style="width: 50px;"></td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <td style="font-weight: normal;">Farm</td>
                                <td><input type="text" class="" required="" readonly id="farm_name" name="farm_name" value="{{work_order.farm_name}}"></td>
                                <td>Crop Calendar</td>
                                <td>
                                    <input type="text" class="form-control" id="crop_plan" name="crop_plan" value="{{work_order.crop_plan}}" readonly>
                                    <input type="hidden" name="crop_calendar_id" id="crop_calendar_id" value="{{work_order.crop_calendar_id}}">
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: normal;">Type</td>
                                <td>
                                    <!-- <select style="height: 28px;padding-top: 3px;padding-bottom: 3px;font-size: 12px;width: 200px;" required="" readonly id="type" name="type">
                                        <option value="">Pesticide Application</option>
                                        <option value="">Fertilizer Application</option>
                                    </select> -->
                                    <input type="text" required="" readonly id="type" name="type" value="{{work_order.type}}">
                                </td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <td style="font-weight: normal;">Description</td>
                                <td colspan="3">
                                    <textarea type="text" class="w-50" readonly id="notes" name="notes"  rows="3" style="resize: none;" value="{{work_order.notes}}">{{work_order.notes}}</textarea>
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;"></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;">Order Details</td>
                                <td style="width: 0px;"></td>
                                <td style="width: 0px;font-weight: bold;"></td>
                                <td style="width: 0px;"></td>
                            </tr>
                            <tr>
                                <td style="font-weight: normal;">Start Date</td>
                                <td style="width: 100px;">
                                    <input type="date" required="" readonly id="date_start" name="date_start" value="{{work_order.date_start}}">
                                    <input type="hidden" id="date_created" name="date_created" value="{{work_order.date_created}}">
                                </td>
                                <td style="width: 100px;">Completion Date</td>
                                <td style="width: 100px;">
                                    {{#if work_order.date_completed}}
                                    <input type="date" required="" readonly id="date_completed" name="date_completed" value="{{work_order.date_completed}}">
                                    {{else}}
                                    N/A
                                    {{/if}}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: normal;">Due Date</td>
                                <td ><input type="date" required="" readonly id="date_due" name="date_due" value="{{work_order.date_due}}"></td>
                                <td ></td>
                                <td>
                                    
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: normal;"></td>
                                <td style="width: 100px;"></td>
                                <td style="width: 100px;"></td>
                                <td style="width: 100px;"></td>
                            </tr>

                            <!-- <td style="width: 0px;font-weight: bold;">Harvest Details</td> -->
                            <!-- <td style="width: 100px;">Rice Yield</td>
                                <td style="width: 100px;"><input type="number" style="width: 80px;"><span style="margin-left: 5px;">sacks</span></td> -->

                            {{#if harvest_details}}
                            <tr>
                                <td colspan="4" style="font-weight: normal;">Harvest Details</td>

                            </tr>
                            <tr>
                                <td style="font-weight: normal;">Sacks Harvested</td>
                                <td>
                                    <input type="number" name="sacks_harvested" id="sacks_harvested" value="{{work_order.harvest_yield}}" readonly min="0">
                                </td>
                                <td></td>
                                <td></td>
                            </tr>
                            {{/if}}

                            {{#if resources}}
                            <tr>
                                <td style="font-weight: normal;"><strong>{{resources.title}}</strong><br></td>
                                <td style="width: 100px;"><strong class="text-danger" id="err_msg"></strong></td>
                                <td style="width: 100px;"></td>
                                <td style="width: 100px;"></td>
                            </tr>
                                {{#each resources}}
                                <tr>
                                    <td></td>
                                    <td colspan="3">
                                        <div class="d-flex">
                                            <input type="text" required="" readonly id="{{../resources.lbl.name}}" name="{{../resources.lbl.name}}" value="{{this.material_name}}" style="">
                                            <input class="hide" style="" type="text" id="{{../resources.lbl.item}}" name="{{../resources.lbl.item}}" value="{{this.item_id}}" readonly="true">
                                            <div class="d-flex flex-column" style="">
                                                <input class=" mx-2" style="width: 100px;" type="number" id="{{../resources.lbl.qty}}" name="{{../resources.lbl.qty}}" step="any" value="{{this.qty}}" readonly>
                                            </div>
                                        </div>
                                            
                                    </td>

                                </tr>
                                {{/each}}
                            {{/if}}

                        </tbody>
                    </table>
                </div>

                <div id="btn_cont">
        
                </div>
            </form>
        </div>
    </div>
</div>

<script type="text/javascript">
    var resource = '{{resources.lbl.name}}';
    var status_editable = {{status_editable}};
    var harvest = {{harvest_editable}}
    function createDOM(obj) {
        var ele;

        ele = document.createElement(obj.type);
        ele.setAttribute('class', obj.class);
        ele.setAttribute('style', obj.style);
        ele.innerHTML = obj.html;

        for (prop in obj.attr) {
            if (Object.prototype.hasOwnProperty.call(obj.attr, prop)) {
                ele.setAttribute(prop, obj.attr[prop]);
            }
        }

        return ele;
    }

    function toggleEditState(show) {
        var editable = ['#status', '#date_start', '#date_due', '#notes', '#'+resource+'_qty'];
        if (!status_editable)
            editable = editable.filter(ele => ele != '#status');

        if (!harvest)
            editable.push('#sacks_harvested');

        var eles = $(editable.join()).attr('readonly', !show);

        if (show) {

            //Create save button
            var target = $('#btn_cont');
            var cont, btn_submit, btn_cancel;
            var btn_attr = {
                type: 'submit',
                id: 'btn_submit',
                form: 'edit_wo_form'
            }
            var btn_cancel_attr = {
                type: 'button',
                id: 'btn_cancel'
            }

            cont = createDOM({ type: 'div', class: 'mr-5 mt-5', style: '', html: '', attr: null });
            btn_submit = createDOM({ type: 'button', class: 'btn btn-success float-right', style: '', html: 'Save', attr: btn_attr });
            btn_cancel = createDOM({ type: 'button', class: 'btn btn-danger float-right mr-2', style: '', html: 'Cancel', attr: btn_cancel_attr });

            cont.appendChild(btn_submit);
            cont.appendChild(btn_cancel);
            target.append(cont);
        }
        else {
            $('#btn_cont').empty();
        }
    }

    $(document).ready(function() {

        $('#wo_edit').on('click', function() {
            toggleEditState(true);
            $('#wo_edit').addClass('hide');
        });

        $('#btn_cont').on('click', '#btn_cancel', function() {
            toggleEditState(false);
            $('#wo_edit').removeClass('hide');
            window.top.location = window.top.location
        });

        $('#edit_wo_form').on('submit', function(e) {
            e.preventDefault();

            if (resource == 'Seed') {
                var qtys = $('[name="Seed_qty"]');
                var qty_arr = [];
                for (var i = 0; i < qtys.length; i++) {
                    qty_arr.push($(qtys[i]).val());
                }
                qty_arr = qty_arr.filter(e => e > 0);

                if (qty_arr.length > 1) {
                    $('#err_msg').html('Only one seed item with quantity > 0 is allowed!');
                }
                else {
                    e.currentTarget.submit();
                }
            }
            else {
                e.currentTarget.submit();
            }

        });
    });

</script>