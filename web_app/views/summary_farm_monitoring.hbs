<div class="container-fluid">
	<div class="card shadow mb-5" style="max-width: 1150px; margin: 0px auto">
	    <div class="card-header py-3" style="background: #939C1F;padding: 16px 20px;height: auto;">
	        <p class="m-0 font-weight-bold" style="color: rgb(255,255,255);">Summarized Farm Monitoring</p>
	    </div>
	     <div class="card-body">
	     	<div class="">
	     		<div class="ml-4">
				  <input class="form-check-input" type="checkbox" value="" id="show_nutrients" checked>
				  <label class="form-check-label" for="flexCheckDefault">
				    Show Nutrient Recommendations
				  </label>
				</div>
				<div class="ml-4">
				  <input class="form-check-input" type="checkbox" value="" id="show_pd" checked>
				  <label class="form-check-label" for="flexCheckChecked">
				    Show Reported Pest/Disease Symptoms
				  </label>
				</div>
	     	</div>
	        <div class="row">
	                <div class="col-12">
	                    <div style="width: auto;">
	                        <table class="table table-bordered tablesorter" id="ipi-table" style="table-layout: fixed; width: 100%; ">
	                            <thead class="thead-dark">
	                            	<tr>
	                            		<td colspan="6" class="text-center bg-dark text-white">
	                            			Active Farms (On-going Crop Calendar)
	                            		</td>
	                            	</tr>
	                                
	                            </thead>
	                            <tbody aria-live="polite" aria-relevant="all">
	                             	{{#each data.calendars}}

	                             	<tr>
	                             		<td colspan="6" style="padding: 0px !important;">
	                             			<table class="table">
	                             				<thead class="thead-dark">
	                             					<tr style="background: #332C1F;">
					                                    <th style="">FARM</th>
					                                    <th style="">Crop Details</th>
					                                    <th style="">DAT</th>
					                                    <th style="">NDVI</th>
					                                    <th style="">SOIL MOISTURE</th>
					                                    <th style=""></th>
					                                </tr>
	                             				</thead>
		                             				
	                             				<tr role="row">
				                                    <td>
				                                    	<div class="d-flex flex-column">
				                                    		<div>{{this.farm_name}}</div>
				                                    		<div>{{this.stage}}</div>
				                                    	</div>
				                                    </td>
				                                    <td>
				                                    	<div class="d-flex flex-column">
				                                    		<div>{{this.seed_name}}</div>
				                                    		<div>{{this.method}}</div>
				                                    		<small>{{this.seed_rate}} kg/ha seed rate</small>
				                                    	</div>
				                                    </td>
				                                    <td>{{this.days_till_harvest}}</td>
				                                    <td>
				                                    	<div class="d-flex flex-column">
				                                    		<div class="d-flex" style="height: max-content;">
							                        		<label>NDVI:&nbsp</label>
							                        		<div class="" id="{{this.farm_name}}_ndvi"> -</div>
							                        		<div id="{{this.farm_name}}_ndvi_help" style="font-size: 14px; margin-top: 3px;" class="text-muted ml-2"></div>
							                        	</div>
							                        	
							                        	<small id="{{this.farm_name}}_ndvi_date">Last updated: -</small>
				                                    	</div>
				                                    </td>
				                                    <td>
				                                    	<div class="d-flex flex-column">
				                                    		<div class="d-flex">
								                        		<label>Soil Moisture:&nbsp</label>
								                        		<div class="" id="{{this.farm_name}}_soil_moisture"> -</div>
								                        		<div id="{{this.farm_name}}_soil_moisture_help" style="font-size: 14px; margin-top: 3px;" class="text-muted ml-2"></div>
								                        	</div>
								                        	
								                        	<small id="{{this.farm_name}}_soil_moisture_date">Last updated: -</small>
				                                    	</div>
				                                    </td>
				                                    <td class="">
				                                        <div class="w-100 mx-auto">
				                                        	<div class="mx-auto dropdown no-arrow" style="">
				                                                <button id="more" class="btn btn-primary btn-sm dropdown-toggle dropdown no-arrow" aria-expanded="false" data-bs-toggle="dropdown" type="button">
				                                                    <i class="fa fa-ellipsis-h d-lg-flex justify-content-lg-center"></i>
				                                                </button>
				                                                <div class="dropdown-menu notSidebar shadow dropdown-menu-end animated--fade-in">
				                                                    <a class="dropdown-item notSidebar" href="/farm_monitoring?farm_id={{this.farm_id}}">View Details</a>
				                                                </div>
				                                            </div>
				                                        </div>
				                                    </td>
				                                </tr>
				                                <tr>
				                                	<td colspan="6" style="padding: 0px !important; border: none;">
				                                		<div class="w-100 d-flex">
				                                			<div class="mr-auto text-dark font-weight-bold d-flex flex-column" style="padding: 0.5rem;">
									                        	Upcoming Nutrient Recommendation Applications:
									                        </div>
									                        <button onclick="toggleInvert(this)" class="icon_btn invert collapse_btn nutrient_btn" data-toggle="collapse" data-target="#nutrient{{@index}}" aria-expanded="false" aria-controls="">
									                        	<i class="fas fa-chevron-circle-up fa-lg m-2"></i>
									                        </button>
				                                		</div>
					                                    
					                                    <div id="nutrient{{@index}}" class="collapse show multi-collapse nutrient_multi_collapse">
					                                    	<table class="table table-borderless" style="margin-bottom: 0px !important;">
									                        	<tr style="border: none;">
									                        		<th style="border: none;">Target Application Date</th>
									                        		<th style="border: none;">Fertilizer</th>
									                        		<th style="border: none;">Description</th>
									                        		<th class="text-right" style="border: none;">Amount</th>
									                        		<th style="border: none;">WO Generated?</th>
									                        	</tr>
									                        	{{#each this.nutrients}}
									                        	<tr>
									                        		<td style="border: none;">{{this.target_application_date}}</td>
									                        		<td style="border: none;">{{this.fertilizer_name}}</td>
									                        		<td style="border: none;">{{this.description}}</td>
									                        		<td class="text-right" style="border: none;">{{this.amount}}</td>
									                        		<td style="border: none;">
									                        			{{#if this.isCreated}}
									                        			Yes
									                        			{{else}}
									                        			No
									                        			{{/if}}
									                        		</td>
									                        	</tr>
									                        	{{/each}}
									                        </table>
					                                    </div>
					                                    	
				                                    </td>
				                                </tr>
				                                <tr>
					                                <td colspan="6" style="padding: 0px !important; border: none;">
					                                	<div class="d-flex w-100">
					                                		<div class="text-dark font-weight-bold mb-0 mr-auto d-flex flex-column" style="padding: 0.5rem;">
									                        	Reported Pest/Disease Symptoms:
									                        </div>
									                        <button onclick="toggleInvert(this)" class="icon_btn invert collapse_btn pest_btn" data-toggle="collapse" data-target="#pest{{@index}}" aria-expanded="false" aria-controls="">
									                        	<i class="fas fa-chevron-circle-up fa-lg m-2"></i>
									                        </button>
					                                	</div>
								                        <div id="pest{{@index}}" class=" collapse show multi-collapse pd_multi_collapse" style="width: 100%;max-width: 1100px; margin-left: 5px; mergin-right: 5px; overflow-y: hidden; white-space: nowrap;">
								                        	<div class="flex-container scrollmenu text-dark font-weight-bold" style="display: flex; flex-flow: row; overflow-x: auto; ">
								                        		{{#if this.empty_symptoms}}No existing symptoms{{/if}}
																{{#each this.symptoms}}
																	<div class="card-body card  mini-card details  flex-child" style="font-size: 12px; min-width: 150px;width: 150px; padding: 5px; margin-bottom: 5px; margin-right: 5px;">
																		<h6>{{this.symptom_name}}</h6><br>
																		{{this.pd_name}}
																	</div>
																{{/each}}
								                        	</div>
								                        </div>
														{{!-- <div class="flex-container scrollmenu " style="display: flex; flex-flow: row; overflow-x: auto;">
															{{#if this.empty_symptoms}}No existing symptoms{{/if}}
															{{#each this.symptoms}}
																<div class="card-body card aos-init mini-card details aos-animate flex-child" data-aos="flip-left" data-aos-duration="350" style="font-size: 12px; min-width: 150px;width: 150px; padding: 5px; margin-bottom: 5px; margin-right: 5px;">
																	<h6>{{this.symptom_name}}</h6><br>
																	{{this.pd_name}}
																</div>
															{{/each}}
															
														</div> --}}
					                                </td>
				                                </tr>
	                             			</table>
	                             		</td>
	                             	</tr>
			                        {{/each}}
	                            </tbody>
	                            <thead class="thead-dark">
	                            	<tr>
	                            		<td colspan="6" class="text-center">
	                            			Inactive Farms
	                            		</td>
	                            	</tr>
	                            </thead>
	                            <tbody>
	                            	<tr>
	                            		<td colspan="6" style="padding: 0px !important">
	                            			<table class="table">
	                            				<thead class="thead-dark">
	                            					<tr>
	                            						<th>Farm</th>
	                            						<th>Previous Crop Details</th>
	                            						<th colspan="2">Previous Calendar Details</th>
	                            						<th></th>
	                            					</tr>
	                            				</thead>

	                            				{{#each data.inactive}}
	                            				<tr>
	                            					<td>
	                            						<div class="d-flex flex-column">
	                            							<div>{{this.farm_name}}</div>
	                            							<div>{{this.farm_area}} ha</div>
	                            							<div>{{this.land_type}}</div>
	                            						</div>
	                            					</td>
	                            					{{#if this.calendar_id}}
	                            					<td>
	                            						<div class="d-flex flex-column">
	                            							<div>{{this.seed_name}}</div>
	                            							<div>{{this.method}}</div>
	                            							<div>{{this.seed_rate}} kg/ha seed rate</div>
	                            						</div>
	                            					</td>
	                            					<td colspan="2">
	                            						<div class="d-flex flex-column w-100">
	                            							<div class="d-flex">
	                            								<div class="d-flex flex-column w-50">
	                            									<div>Crop Plan: {{this.crop_plan}}</div>
	                            									<div class="mt-2">Land Prep: {{this.land_prep_date}}</div>
	                            									<div class="mt-1">Sowing Date: {{this.sowing_date}}</div>
	                            								</div>
	                            								<div class="d-flex flex-column w-50">
	                            									<div>&nbsp</div>
	                            									<div class="mt-2">Harvest Date: {{this.harvest_date}}</div>
	                            									<div class="mt-1 font-weight-bold">Harvest: {{this.harvest_yield}} cavans/ha</div>
	                            								</div>
	                            							</div>
	                            							<!-- <div class="w-50">
	                            								
	                            							</div>
	                            							<div class="w-50">
	                            								
	                            							</div> -->
	                            						</div>
	                            					</td>
	                            					{{else}}
	                            					<td colspan="3" class="text-center text-muted">No existing crop calendar records</td>
	                            					{{/if}}
	                            					<td class="">
				                                        <div class="w-100 mx-auto">
				                                        	<div class="mx-auto dropdown no-arrow" style="">
				                                                <button id="more" class="btn btn-primary btn-sm dropdown-toggle dropdown no-arrow" aria-expanded="false" data-bs-toggle="dropdown" type="button">
				                                                    <i class="fa fa-ellipsis-h d-lg-flex justify-content-lg-center"></i>
				                                                </button>
				                                                <div class="dropdown-menu notSidebar shadow dropdown-menu-end animated--fade-in">
				                                                    <a class="dropdown-item notSidebar" href="/farm_monitoring?farm_id={{this.farm_id}}">View Details</a>
				                                                </div>
				                                            </div>
				                                        </div>
				                                    </td>
	                            				</tr>
	                            				{{/each}}
	                            			</table>
	                            		</td>
	                            	</tr>
	                            </tbody>
	                        </table>
	                    </div>
	                </div>
	            </div>
	    </div>
	</div>
</div>

<script type="text/javascript">

	function toggleShow(type, val) {
		var target;

		if (type == 'nutrient') {
			target = '.nutrient_multi_collapse';
			btn_target = '.nutrient_btn';
		}
		else {
			btn_target = '.pest_btn';
			target = '.pd_multi_collapse';
		}

		if (val) {
			$(btn_target).addClass('invert');
			$(target).collapse('show');
		}
		else {
			$(btn_target).removeClass('invert');
			$(target).collapse('hide');
		}
	}

	function toggleInvert(target) {
		if ($(target).hasClass('invert')) {
			$(target).removeClass('invert');
		}
		else {
			$(target).addClass('invert');
		}
	}

	$('#show_nutrients').on('change', function() {
		toggleShow('nutrient', $(this).is(':checked'));
	});

	$('#show_pd').on('change', function() {
		toggleShow('pd', $(this).is(':checked'));
	});

	$(function () {
	  $('[data-toggle="tooltip"]').tooltip({
	  	container: 'body',
	  	boundary: 'window'
	  })
	});

	function formatDate(date, format) {
		var year,month,day;
		const monthNames = ["", "Jan", "Feb", "Mar", "Apr", "May", "Jun",
		  "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
		];
		year = date.getFullYear();
		month = date.getMonth()+1;
		day = date.getDate();

		if (format === 'MM/DD/YYYY') {
			if (month < 10)
				month = '0'+month;
			if (day < 10)
				day = '0'+day;
			date = month+'/'+day+'/'+year;
		}
		else if (format === 'YYYY-MM-DD') {
			if (month < 10)
				month = '0'+month;
			if (day < 10)
				day = '0'+day;
			date = year+'-'+month+'-'+day;
		}
		else if (format === 'mm DD, YYYY') {
			date = monthNames[month]+' '+day+', '+year;
		}
		else if (format === 'HH:m') {
			var hour = parseInt(date.getHours());
			var lbl;
			if (hour < 12)
				lbl = 'AM';
			else {
				lbl = 'PM';
			}

			if (hour == 0)
				hour = 12;
			else if (hour > 12)
				hour -= 12;

			date = hour+':'+(date.getMinutes() < 10 ? '0' : '') + date.getMinutes()+lbl;
		}
		else if (format == 'HH') {
			var hour = parseInt(date.getHours());
			var lbl;
			if (hour < 12)
				lbl = 'AM';
			else {
				lbl = 'PM';
			}

			if (hour == 0)
				hour = 12;
			else if (hour > 12)
				hour -= 12;

			date = hour+':'+'00'+lbl;
		}
		else if (format === 'YYYY-MM-DD : HH:m') {
			if (month < 10)
				month = '0'+month;
			if (day < 10)
				day = '0'+day;

			var hour = parseInt(date.getHours());
			var lbl;
			if (hour < 12)
				lbl = 'AM';
			else {
				lbl = 'PM';
			}

			if (hour == 0)
				hour = 12;
			else if (hour > 12)
				hour -= 12;

			date = year+'-'+month+'-'+day+' - '+hour+':'+(date.getMinutes() < 10 ? '0' : '') + date.getMinutes()+lbl;
		}

		return date;
	}

	jQuery.ajaxSetup({async: false });
	var view = 'summary monitoring';
	var obj = {{{JSON_data.farms}}};

	var n_date = new Date();
	n_date.setDate(n_date.getDate() - 30);
	var n = new Date();

	for (var i = 0; i < obj.length; i++) {
		var query = { polygon_id: obj[i].id, start: n_date, end: n };

		$.get('/agroapi/ndvi/imagery', query, function(imagery) {
			if (imagery.length != 0) {
				$.get(imagery[0].stats.ndvi, {}, function(stats) {
					$(`[id='${obj[i].name}_ndvi']`).html(' '+Math.round(stats.max * 100) / 100);
					$(`[id='${obj[i].name}_ndvi_date']`).html('Last updated: '+formatDate(new Date(imagery[0].dt), 'mm DD, YYYY'));
					$(`[id='${obj[i].name}_ndvi_help']`).html(`N/A`);
				});
			}
			else {

			}
		});

		$.get('/agroapi/soil/current', { polyid: obj[i].id }, function(soil) {
			$(`[id='${obj[i].name}_soil_moisture']`).html(soil.moisture == ' N/A' ? 'N/A' : ' '+Math.round(soil.moisture * 100) / 100 + '%');
			$(`[id='${obj[i].name}_soil_moisture_date']`).html('Last updated: '+formatDate(new Date(soil.dt), 'mm DD, YYYY'));
			$(`[id='${obj[i].name}_soil_moisture_help']`).html(`N/A`);
		});
	}
</script>